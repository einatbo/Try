/*---------------------------------------------------------------------------------------------------------*/
/*  Nuvoton Technology Corporation confidential                                                            */
/*                                                                                                         */
/*  Copyright (c) 2011 by Nuvoton Technology Corporation                                                   */
/*  All rights reserved                                                                                    */
/*                                                                                                         */
/*<<<------------------------------------------------------------------------------------------------------*/
/* File Contents:                                                                                          */
/*   main.c                                                                                                */
/*            This file contains main entry point of Touch SPI to USB HID bridge firmware                  */
/* Project:                                                                                                */
/*            Touch bridge                                                                                 */
/*---------------------------------------------------------------------------------------------------------*/

#define MAIN_GLOBALS

#include "usb_touch.h"
#include "hid.h"
#include "bridge.h"
#include "hi_if.h"
#include "transport_if.h"

/*---------------------------------------------------------------------------------------------------------*/
/*                                Main module functions                                                    */
/*---------------------------------------------------------------------------------------------------------*/
static DEFS_STATUS  MAIN_Init(void);
static void         MAIN_Int0Handler(UINT16 intNum);

/*---------------------------------------------------------------------------------------------------------*/
/*                                Main module variables                                                    */
/*---------------------------------------------------------------------------------------------------------*/
USB_TOUCH_CALLBACKS usbTouchCallbacks;


/*---------------------------------------------------------------------------------------------------------*/
/* Function: main                                                                                          */
/*                                                                                                         */
/* Parameters:   none                                                                                      */
/* Returns:      none                                                                                      */
/* Side effects: none                                                                                      */
/* Description:                                                                                            */
/*               This routine implmentes main entry point of the bridge                                    */
/*                                                                                                         */
/*lint -efunc(716, main)                                                                                   */
/*---------------------------------------------------------------------------------------------------------*/
int main ()
{
    BOOLEAN deviceFound = FALSE;
    BOOLEAN initNeeded  = TRUE;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Handle firmware processes                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    while (TRUE)
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* Check if initialization is needed                                                               */
        /*-------------------------------------------------------------------------------------------------*/
        if (initNeeded)
        {
            /*---------------------------------------------------------------------------------------------*/
            /* Perform initializations                                                                     */
            /*---------------------------------------------------------------------------------------------*/
            (void)MAIN_Init();

            /*---------------------------------------------------------------------------------------------*/
            /* Mark initialization finished                                                                */
            /*---------------------------------------------------------------------------------------------*/
            initNeeded = FALSE;

            /*---------------------------------------------------------------------------------------------*/
            /* After initialization perform device search                                                  */
            /*---------------------------------------------------------------------------------------------*/
            deviceFound = FALSE;
        }

        /*-------------------------------------------------------------------------------------------------*/
        /* Check if device wasn't found till now                                                           */
        /*-------------------------------------------------------------------------------------------------*/
        if (!deviceFound)
        {
            /*---------------------------------------------------------------------------------------------*/
            /* Find the device                                                                             */
            /*---------------------------------------------------------------------------------------------*/
            deviceFound = (BRIDGE_Find() == DEFS_STATUS_OK);
        }
        else
        {
            /*---------------------------------------------------------------------------------------------*/
            /*                                      Device is found!                                       */
            /*---------------------------------------------------------------------------------------------*/

            /*---------------------------------------------------------------------------------------------*/
            /* Send data to MFTS chip                                                                      */
            /*---------------------------------------------------------------------------------------------*/
            if (BRIDGE_SendToMFTS() != DEFS_STATUS_OK)
            {
                /*-----------------------------------------------------------------------------------------*/
                /* Something got wrong. Redo the initialization                                            */
                /*-----------------------------------------------------------------------------------------*/
                initNeeded = TRUE;
            }

            /*---------------------------------------------------------------------------------------------*/
            /* Send data to HOST                                                                           */
            /*---------------------------------------------------------------------------------------------*/
            if (BRIDGE_SendToHost() != DEFS_STATUS_OK)
            {
                /*-----------------------------------------------------------------------------------------*/
                /* Something got wrong. Redo the initialization                                            */
                /*-----------------------------------------------------------------------------------------*/
                initNeeded = TRUE;
            }
        }
    }
}

/*---------------------------------------------------------------------------------------------------------*/
/* Function:     MAIN_Init                                                                                 */
/*                                                                                                         */
/* Parameters:   none                                                                                      */
/* Returns:      none                                                                                      */
/* Side effects: none                                                                                      */
/* Description:                                                                                            */
/*               This routine performs one-time initializations for NMTP bridge                            */
/*---------------------------------------------------------------------------------------------------------*/
static DEFS_STATUS MAIN_Init(void)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* Init callbacks                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    usbTouchCallbacks.bulkGetData           = NULL;
    usbTouchCallbacks.interruptGetData      = NULL;
#if defined BULK_MODE
    usbTouchCallbacks.bulkGetData           = BRIDGE_GetBulkData;
    usbTouchCallbacks.bulkGetDataFinished   = BRIDGE_GetBulkDataFinished;
    usbTouchCallbacks.bulkSetData           = BRIDGE_RecieveData;
#endif

    /*-----------------------------------------------------------------------------------------------------*/
    /* Enable interrupt controller                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    ICU_Init(TRUE);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Register default INT0 handler                                                                       */
    /*-----------------------------------------------------------------------------------------------------*/
    ICU_InstallHandler(ICU_INT_0, MAIN_Int0Handler);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Initialize HID logic                                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    DEFS_STATUS_RET_CHECK(TRANSPORT_Init(NULL));

    /*-----------------------------------------------------------------------------------------------------*/
    /* Initialize the USB stack                                                                            */
    /*-----------------------------------------------------------------------------------------------------*/
    DEFS_STATUS_RET_CHECK(HI_Init(&usbTouchCallbacks));

    /*-----------------------------------------------------------------------------------------------------*/
    /* Initialize the bridge                                                                               */
    /*-----------------------------------------------------------------------------------------------------*/
    BRIDGE_Init();

    /*-----------------------------------------------------------------------------------------------------*/
    /* Enable global interrupts                                                                            */
    /*-----------------------------------------------------------------------------------------------------*/
    ENABLE_INTERRUPTS();

    return DEFS_STATUS_OK;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        MAIN_Int0Handler                                                                       */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  intNum -                                                                               */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine handles INT0 abnormal interrupt                                           */
/*---------------------------------------------------------------------------------------------------------*/
static void MAIN_Int0Handler(UINT16 intNum)
{
}


#undef MAIN_GLOBALS



